<html>
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
        <title>Crypto portfolio</title>

        <script
            src="https://code.jquery.com/jquery-3.2.1.min.js"
            integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4="
            crossorigin="anonymous"></script>

        <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"
            integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa"
            crossorigin="anonymous"></script>

        <script type="text/javascript" src="https://static.cryptowat.ch/assets/scripts/embed.bundle.js"></script>

        <link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css"
            rel="stylesheet"
            integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u"
            crossorigin="anonymous">
    </head>
    <body>
        <!--
        <script type="text/javascript" src="https://files.coinmarketcap.com/static/widget/currency.js"></script>
        <div class="coinmarketcap-currency-widget" data-currency="ripple" data-base="EUR" data-secondary="" data-ticker="true" data-rank="true" data-marketcap="true" data-volume="true" data-stats="EUR" data-statsticker="false"></div>

        <div class="coinmarketcap-currency-widget" data-currency="ethereum" data-base="EUR" data-secondary="" data-ticker="true" data-rank="true" data-marketcap="true" data-volume="true" data-stats="EUR" data-statsticker="false"></div>

        <div class="coinmarketcap-currency-widget" data-currency="bitcoin" data-base="EUR" data-secondary="" data-ticker="true" data-rank="true" data-marketcap="true" data-volume="true" data-stats="EUR" data-statsticker="false"></div>
        -->
        <div class="container">
            <div id="ethereum"></div>
            <div id="ripple"></div>
            <div id="bitcoin"></div>
            <div class="total" id="totalEarning"></div>
            <br>
            <div id="chart-container"></div>
        </div>

        <style>
        .line-32 {
            line-height: 30px;
            margin-top: 10px;
            margin-bottom: 10px;
            padding-top: 5px;
            padding-bottom: 5px;
            border: 1px solid lightgray;
            border-radius: 3px;
        }

        .total>div {
            background-color:lightsteelblue;
        }
        </style>

        <script>
            var chart = new cryptowatch.Embed('coinbase', 'ethusd', {
                timePeriod: '1H',
                presetColorScheme: 'ballmer',
                /*customColorScheme: {
                    bg:           "000000",
                    text:         "b2b2b2",
                    textStrong:   "e5e5e5", // Emphasized text
                    textWeak:     "7f7f7f", // De-emphasized text
                    short:        "C60606", // Stroke color of decreasing candlesticks, ask orders, and other "short" related UI
                    shortFill:    "C60606", // Fill color of decreasing candlesticks
                    long:         "00B909", // Color of increasing candlesticks, bid orders, and other "long" related UI
                    longFill:     "000000", // Fill color of increasing candlesticks
                    cta:          "363D52", // Color of buttons and other prominent UI elements
                    ctaHighlight: "414A67", // Color of buttons and other prominent UI elements when hovered over
                    alert:        "FFD506", // Color associated with price & volume alerts
                }*/
            });

            // ======
            // Benoit
            // index.html?bitcoin={%22id%22:%22bitcoin%22,%22boughtPrice%22:2000,%22quantity%22:0.0093}&ethereum={%22id%22:%22ethereum%22,%22boughtPrice%22:129,%22quantity%22:7.22%20}&ripple={%22id%22:%22ripple%22,%22boughtPrice%22:0.21428571428,%22quantity%22:280}
            // ======

            // ======
            // Nico
            // index.html?bitcoin={%22id%22:%22bitcoin%22,%22boughtPrice%22:2207,%22quantity%22:0.07594672}&ethereum={%22id%22:%22ethereum%22,%22boughtPrice%22:174.7,%22quantity%22:1.88%20}&ripple={%22id%22:%22ripple%22,%22boughtPrice%22:0.21428571428,%22quantity%22:0}
            // ======
            chart.mount('#chart-container');

            var totalEarning = 0;
            var totalWallet = 0;


            var supportedCurrencies = ["bitcoin", "ethereum", "ripple"];
            var foundCurrencies = [];

            supportedCurrencies.forEach((currName) => {
                var currencyUrlParam = getUrlParameter(currName);
                if (currencyUrlParam)
                    foundCurrencies.push(JSON.parse(currencyUrlParam));
            });        

            // Refresh every 30 sec
            updatePersonnalDashboard(...foundCurrencies);
            var t = setInterval(() => updatePersonnalDashboard(...foundCurrencies), 30000);

            function updatePersonnalDashboard(...assets) {
                totalEarning = 0;
                totalWallet = 0;

                assets.forEach((asset) => {
                    displayCurrency(asset.id, asset.quantity, asset.boughtPrice);
                });
            }

            function displayCurrency(currency, amount, boughtPrice) {
                return $.get(`https://api.coinmarketcap.com/v1/ticker/${currency}/?convert=EUR`)
                .done(function(data) {
                    computeDisplay(data[0], currency, amount, boughtPrice);
                });
            }

            function computeDisplay(data, currency, amount, boughtPrice) {
                data.percent_change_1h;
                data.percent_change_24h;
                data.percent_change_7d;
                data.price_eur;

                var eurEarned = amount * data.price_eur - amount * boughtPrice;
                var eurWallet = amount * data.price_eur;
                totalEarning += eurEarned;
                totalWallet += eurWallet;
                $(`#totalEarning`).html(`
<div class="row line-32">
    <div class="col-xs-1"></div>
    <div class="col-xs-5"><b>[Total]</b> Wallet: ${getAmountHtml(totalWallet.toFixed(2), "€")} - Earned: ${getAmountHtml(totalEarning.toFixed(2), "€")}</div>
    <div class="col-xs-6"></div>
</div>`);
                $(`#${data.id}`).html(getFormattedEntry(`https://files.coinmarketcap.com/static/img/coins/64x64/${data.id}.png`,
                                                        data.name,
                                                        Number(data.price_usd).toFixed(2),
                                                        eurWallet.toFixed(2),
                                                        eurEarned.toFixed(2),
                                                        data.percent_change_7d,
                                                        data.percent_change_24h,
                                                        data.percent_change_1h));
            }

            function getFormattedEntry(imgUrl, name, price, wallet, earned, percentageChange7d, percentageChange24h, percentageChange1h) {
                return `
<div class="row line-32">
    <div class="col-xs-1"><img height="32px" src="${imgUrl}"></img></div>
    <div class="col-xs-5"><b>[${name}: ${price}$]</b> Wallet: ${getAmountHtml(wallet, "€")} - Earned: ${getAmountHtml(earned, "€")}</div>
    <div class="col-xs-6">(7j: ${getAmountHtml(percentageChange7d, "%")}, 24h: ${getAmountHtml(percentageChange24h, "%")}, 1h: ${getAmountHtml(percentageChange1h, "%")})</div>
</div>`
            }

            function getAmountHtml(percentage, symbole) {
                const risingColor = "green";
                const droppingColor = "red";
                var color;
                if (percentage >= 0)
                    color = risingColor;
                else
                    color = droppingColor;

                return `<label style="color: ${color}">${percentage}${symbole}</label>`
            }

            function getUrlParameter(sParam) {
                var sPageURL = decodeURIComponent(window.location.search.substring(1)),
                    sURLVariables = sPageURL.split('&'),
                    sParameterName,
                    i;

                for (i = 0; i < sURLVariables.length; i++) {
                    sParameterName = sURLVariables[i].split('=');

                    if (sParameterName[0] === sParam) {
                        return sParameterName[1] === undefined ? true : sParameterName[1];
                    }
                }
            };

        </script>
    </body>
</html>