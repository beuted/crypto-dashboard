<html>
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
        <title>Crypto portfolio</title>

        <script
            src="https://code.jquery.com/jquery-3.2.1.min.js"
            integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4="
            crossorigin="anonymous"></script>

        <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"
            integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa"
            crossorigin="anonymous"></script>

        <script type="text/javascript" src="https://static.cryptowat.ch/assets/scripts/embed.bundle.js"></script>

        <link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css"
            rel="stylesheet"
            integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u"
            crossorigin="anonymous">
    </head>
    <body>
        <!--
        <script type="text/javascript" src="https://files.coinmarketcap.com/static/widget/currency.js"></script>
        <div class="coinmarketcap-currency-widget" data-currency="ripple" data-base="EUR" data-secondary="" data-ticker="true" data-rank="true" data-marketcap="true" data-volume="true" data-stats="EUR" data-statsticker="false"></div>

        <div class="coinmarketcap-currency-widget" data-currency="ethereum" data-base="EUR" data-secondary="" data-ticker="true" data-rank="true" data-marketcap="true" data-volume="true" data-stats="EUR" data-statsticker="false"></div>

        <div class="coinmarketcap-currency-widget" data-currency="bitcoin" data-base="EUR" data-secondary="" data-ticker="true" data-rank="true" data-marketcap="true" data-volume="true" data-stats="EUR" data-statsticker="false"></div>
        -->
        <div class="container">
            <div id="ethereum"></div>
            <div id="ripple"></div>
            <div id="bitcoin"></div>
            <div id="siacoin"></div>
            <div id="nexus"></div>
            <div class="total" id="totalEarning"></div>
            <br>
            <div id="chart-container">
                <ul class="nav nav-tabs" role="tablist">
                </ul>
                <div class="tab-content">
                </div>
            </div>
        </div>

        <style>
        .line-32 {
            line-height: 30px;
            margin-top: 10px;
            margin-bottom: 10px;
            padding-top: 5px;
            padding-bottom: 5px;
            border: 1px solid lightgray;
            border-radius: 3px;
        }

        .total>div {
            background-color:lightsteelblue;
        }

        .chart {
            height: 500px;
        }
        </style>

        <script>
            // ======
            // Benoit
            // index.html?bitcoin={%22id%22:%22bitcoin%22,%22moneyInvested%22:0,%22quantity%22:0}&ethereum={%22id%22:%22ethereum%22,%22moneyInvested%22:1000,%22quantity%22:7.22%20}&ripple={%22id%22:%22ripple%22,%22moneyInvested%22:60,%22quantity%22:280}
            // ======

            // ======
            // Nico
            // index.html?bitcoin={%22id%22:%22bitcoin%22,%22moneyInvested%22:2207,%22quantity%22:0.07594672}&ethereum={%22id%22:%22ethereum%22,%22moneyInvested%22:174.7,%22quantity%22:1.88%20}&ripple={%22id%22:%22ripple%22,%22moneyInvested%22:0.21428571428,%22quantity%22:0}
            // ======

            var totalEarning = 0;
            var totalWallet = 0;
            var totalInvested = 0;

            var supportedCurrencies = ["bitcoin", "ethereum", "ripple", "siacoin", "nexus"];
            var charts = {
                "ethereum": new cryptowatch.Embed('kraken', 'etheur', {
                    timePeriod: '1H',
                    presetColorScheme: 'ballmer'
                }),
                "bitcoin": new cryptowatch.Embed('kraken', 'btceur', {
                    timePeriod: '1H',
                    presetColorScheme: 'ballmer'
                }),
                "ripple" : new cryptowatch.Embed('kraken', 'xrpeur', {
                    timePeriod: '1H',
                    presetColorScheme: 'ballmer'
                })
            }
            var foundCurrencies = [];

            supportedCurrencies.forEach((currName) => {
                var currencyUrlParam = getUrlParameter(currName);
                if (currencyUrlParam)
                    foundCurrencies.push(JSON.parse(currencyUrlParam));
            });

            // build tabs
            Object.entries(charts).forEach(([currName, chart]) => {
                $('.nav-tabs', '#chart-container').append(`
                    <li role="presentation">
                        <a href="#chart-pane-${currName}" data-currency-name="${currName}" aria-controls="${currName}" role="tab" data-toggle="tab">${currName}</a>
                    </li>
                `)

                $('.tab-content', '#chart-container').append(`
                    <div role="tabpanel" class="tab-pane" id="chart-pane-${currName}">
                        <div class="chart chart-${currName}"></div>
                    </div>
                `)
            });

            // open tab and build chart
            $('.nav-tabs a', '#chart-container').click(function (e) {
                e.preventDefault()
                $(this).tab('show')
                var currName = $(this).data('currency-name')
                if ($('#chart-pane-' + currName + ' .chart').is(':empty')) {
                    charts[currName].mount('#chart-pane-' + currName + ' .chart')
                }
            })

            // load first dashboard
            $('.nav-tabs a', '#chart-container').first().trigger('click')

            // Refresh every 30 sec
            updatePersonnalDashboard(...foundCurrencies);
            var t = setInterval(() => updatePersonnalDashboard(...foundCurrencies), 30000);

            function updatePersonnalDashboard(...assets) {
                totalEarning = 0;
                totalWallet = 0;
                totalInvested = 0;

                assets.forEach((asset) => {
                    displayCurrency(asset.id, asset.quantity, asset.moneyInvested);
                });
            }

            function displayCurrency(currency, amount, moneyInvested) {
                return $.get(`https://api.coinmarketcap.com/v1/ticker/${currency}/?convert=EUR`)
                .done(function(data) {
                    computeDisplay(data[0], currency, amount, moneyInvested);
                });
            }

            function computeDisplay(data, currency, amount, moneyInvested) {
                data.percent_change_1h;
                data.percent_change_24h;
                data.percent_change_7d;
                data.price_eur;

                var eurEarned = amount * data.price_eur - moneyInvested;
                var eurWallet = amount * data.price_eur;
                totalEarning += eurEarned;
                totalWallet += eurWallet;
                totalInvested += moneyInvested;
                var totalPercentageEarned = ((totalEarning/totalInvested)*100).toFixed(2);


                $(`#totalEarning`).html(`
                    <div class="row line-32">
                        <div class="col-xs-1"></div>
                        <div class="col-xs-11">
                            <b>[Total]</b>&nbsp;
                            Wallet: ${getAmountHtml(totalWallet.toFixed(2), "€")} -&nbsp;
                            Invested: ${getAmountHtml(totalInvested.toFixed(2), "€")} -&nbsp;
                            Earned: ${getAmountHtml(totalEarning.toFixed(2), "€")}  (${getAmountHtml(totalPercentageEarned, "%")})

                        </div>
                    </div>
                `);

                $(`#${data.id}`).html(
                    getFormattedEntry(
                        `https://files.coinmarketcap.com/static/img/coins/64x64/${data.id}.png`,
                        data.name,
                        Number(data.price_eur).toPrecision(5),
                        eurWallet.toFixed(2),
                        eurEarned.toFixed(2),
                        data.percent_change_7d,
                        data.percent_change_24h,
                        data.percent_change_1h
                    )
                );
            }

            function getFormattedEntry(imgUrl, name, price, wallet, earned, percentageChange7d, percentageChange24h, percentageChange1h) {
                var percentageEarned = ((earned/wallet)*100).toFixed(2);

                return `
                    <div class="row line-32">
                        <div class="col-xs-1"><img height="32px" src="${imgUrl}"></img></div>
                        <div class="col-xs-5">
                            <b>[${name}: ${price}€]</b>&nbsp;
                            Wallet: ${getAmountHtml(wallet, "€")} -&nbsp;
                            Earned: ${getAmountHtml(earned, "€")} -&nbsp;
                            ${getAmountHtml(percentageEarned, "%")}
                        </div>
                        <div class="col-xs-6">
                            (7j: ${getAmountHtml(percentageChange7d, "%")},&nbsp;
                            24h: ${getAmountHtml(percentageChange24h, "%")},&nbsp;
                            1h: ${getAmountHtml(percentageChange1h, "%")})
                        </div>
                    </div>
                `
            }

            function getAmountHtml(percentage, symbole) {
                const risingColor = "green";
                const droppingColor = "red";
                var color;
                if (percentage >= 0)
                    color = risingColor;
                else
                    color = droppingColor;

                return `<label style="color: ${color}">${percentage}${symbole}</label>`
            }

            function getUrlParameter(sParam) {
                var sPageURL = decodeURIComponent(window.location.search.substring(1)),
                    sURLVariables = sPageURL.split('&'),
                    sParameterName,
                    i;

                for (i = 0; i < sURLVariables.length; i++) {
                    sParameterName = sURLVariables[i].split('=');

                    if (sParameterName[0] === sParam) {
                        return sParameterName[1] === undefined ? true : sParameterName[1];
                    }
                }
            };

        </script>
    </body>
</html>
